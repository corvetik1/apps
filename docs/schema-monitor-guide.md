# Руководство по мониторингу JSON-схем

## Введение

Для обеспечения соответствия между JSON-схемами и их тестами в проекте реализован механизм мониторинга схем. Этот механизм позволяет автоматически выявлять несоответствия между схемами и тестами, что помогает поддерживать высокое качество кода и предотвращать ошибки.

## Как это работает

Мониторинг схем выполняет следующие проверки:

1. **Наличие тестов для всех схем**: Проверяет, что для каждой JSON-схемы в директории `docs/json-schema` существует соответствующий тест в директории `libs/shared/src/lib/types/__tests__`.

2. **Соответствие свойств**: Проверяет, что все свойства, определенные в схеме, проверяются в тесте, и наоборот.

3. **Соответствие перечислений (enum)**: Проверяет, что значения перечислений в тестах соответствуют значениям в схемах.

## Когда запускается мониторинг

Мониторинг схем запускается автоматически в следующих случаях:

1. **При коммите**: Если изменены файлы схем или тестов, мониторинг запускается перед коммитом (pre-commit hook).

2. **В CI/CD**: При пуш-коммите в ветки `main` или `develop`, а также при создании Pull Request, если изменены файлы схем или тестов.

3. **Вручную**: Разработчик может запустить мониторинг вручную с помощью команды `pnpm schema:monitor`.

## Как использовать

### Запуск мониторинга вручную

```bash
# Запуск мониторинга схем
pnpm schema:monitor
```

### Интерпретация результатов

После запуска мониторинга генерируется отчет в файле `docs/schema-monitor-report.md`, который содержит информацию о всех обнаруженных несоответствиях.

Пример отчета:

```markdown
# Отчет о мониторинге JSON-схем и их тестов

Дата: 2025-04-29T15:30:00.000Z

Всего проверено схем: 15
Схемы с проблемами: 2

## Детали проблем

### user.schema.json

- ✅ Тест: user-schema.spec.ts
- ❌ Свойства, отсутствующие в тесте:
  - `avatar`
  - `phoneNumber`

### investment.schema.json

- ✅ Тест: investment-schema.spec.ts
- ❌ Несоответствия в перечислениях:
  - `type`:
    - Ожидается: ["stock","bond","etf","mutual_fund","real_estate","deposit","cryptocurrency","other"]
    - Фактически: ["stock","bond","etf","mutual_fund","real_estate","deposit","crypto","other"]
```

## Как исправить несоответствия

### Отсутствующие свойства в тесте

Если в отчете указано, что в тесте отсутствуют свойства, которые есть в схеме, необходимо добавить проверки для этих свойств в соответствующий тест.

Пример:

```typescript
// Добавляем проверку для отсутствующих свойств
expectStringProperty(properties, 'avatar');
expectStringProperty(properties, 'phoneNumber');
```

### Несоответствия в перечислениях

Если в отчете указано, что значения перечислений в тесте не соответствуют значениям в схеме, необходимо обновить перечисления в тесте.

Пример:

```typescript
// Исправляем несоответствие в перечислении
expectEnumProperty(properties, 'type', [
  'stock',
  'bond',
  'etf',
  'mutual_fund',
  'real_estate',
  'deposit',
  'cryptocurrency',
  'other',
]);
```

## Рекомендации

1. **Всегда запускайте тесты после изменения схем**: После внесения изменений в JSON-схемы запускайте тесты с помощью команды `npx nx test shared --testPathPattern=schema`, чтобы убедиться, что тесты проходят успешно.

2. **Используйте утилиты из `schema-test-utils.ts`**: Для проверки свойств схем используйте утилиты из файла `schema-test-utils.ts`, такие как `expectStringProperty`, `expectNumberProperty`, `expectEnumProperty` и т.д.

3. **Обновляйте тесты при изменении схем**: При добавлении новых свойств в схему или изменении существующих не забывайте обновлять соответствующие тесты.

4. **Проверяйте отчет мониторинга**: Регулярно проверяйте отчет мониторинга схем, чтобы выявлять и исправлять несоответствия.

## Заключение

Мониторинг JSON-схем является важной частью процесса разработки, который помогает поддерживать высокое качество кода и предотвращать ошибки. Следуя рекомендациям, изложенным в этом руководстве, вы можете обеспечить соответствие между схемами и их тестами, что повысит надежность и стабильность приложения.

Если у вас возникли вопросы или предложения по улучшению мониторинга схем, обратитесь к техническому лиду проекта.
