# Руководство по генератору JSON-схем

## Обзор

Генератор JSON-схем — это инструмент, который автоматически создает JSON-схемы на основе TypeScript-интерфейсов. Он анализирует интерфейсы в директории `libs/shared/src/lib/types` и генерирует соответствующие JSON-схемы в директории `docs/json-schema`.

Генератор также может опционально создавать тесты для схем в директории `libs/shared/src/lib/types/__tests__`.

## Преимущества использования генератора схем

1. **Автоматизация** — исключает ручное создание и обновление JSON-схем
2. **Синхронизация** — гарантирует соответствие схем TypeScript-интерфейсам
3. **Стандартизация** — обеспечивает единый формат всех JSON-схем
4. **Тестирование** — автоматически создает тесты для схем

## Запуск генератора схем

Генератор схем можно запустить с помощью npm-скрипта:

```bash
pnpm schema:generate
```

Генератор автоматически запускается при коммите, если были изменены TypeScript-интерфейсы в директории `libs/shared/src/lib/types`.

## Как работает генератор схем

1. Анализирует TypeScript-интерфейсы с помощью TypeScript Compiler API
2. Извлекает информацию о свойствах, типах, описаниях и примерах из JSDoc-комментариев
3. Генерирует JSON-схемы в формате JSON Schema Draft-07
4. Сохраняет схемы в директории `docs/json-schema`
5. Опционально создает тесты для схем в директории `libs/shared/src/lib/types/__tests__`

## Поддерживаемые типы данных

Генератор схем поддерживает следующие типы данных:

- `string` — строки
- `number` — числа
- `boolean` — булевы значения
- `Date` — даты (преобразуются в строки с форматом `date-time`)
- `Array<T>` или `T[]` — массивы
- `Record<K, V>` или `object` — объекты
- `enum` — перечисления

## Использование JSDoc для улучшения схем

Генератор схем использует JSDoc-комментарии для улучшения генерируемых схем:

````typescript
/**
 * Интерфейс пользователя системы
 *
 * @example
 * ```typescript
 * const user: User = {
 *   id: '1',
 *   email: 'user@example.com',
 *   name: 'John Doe',
 *   role: Role.User,
 *   createdAt: '2023-01-01T00:00:00Z',
 *   updatedAt: '2023-01-01T00:00:00Z',
 * };
 * ```
 */
export interface User {
  /** Уникальный идентификатор пользователя */
  id: string;
  /** Email пользователя */
  email: string;
  /** Имя пользователя */
  name: string;
  /** Роль пользователя в системе */
  role: Role | string;
  /** Дата создания записи */
  createdAt: string;
  /** Дата последнего обновления записи */
  updatedAt: string;
}
````

Поддерживаемые JSDoc-теги:

- `@example` — примеры использования
- `@format` — формат значения (например, `date-time`, `email`, `uri`)

## Игнорирование интерфейсов

Некоторые интерфейсы могут быть исключены из генерации схем. По умолчанию игнорируются следующие интерфейсы:

- `SchemaProperty`
- `JsonSchema`
- `JsonSchemaMetadata`

Вы можете изменить список игнорируемых интерфейсов в файле `tools/schema-generator/schema-generator.ts`.

## Интеграция с CI/CD

Генератор схем интегрирован с pre-commit хуком, который запускает генератор при изменении TypeScript-интерфейсов. Сгенерированные схемы автоматически добавляются в коммит.

## Проверка соответствия схем и тестов

После генерации схем рекомендуется запустить мониторинг схем, чтобы убедиться, что все схемы имеют соответствующие тесты:

```bash
pnpm schema:monitor
```

Мониторинг схем также автоматически запускается при коммите, если были изменены JSON-схемы или тесты.

## Рекомендации по работе с генератором схем

1. **Используйте JSDoc-комментарии** — они улучшают качество генерируемых схем
2. **Следуйте соглашениям по именованию** — используйте PascalCase для интерфейсов
3. **Проверяйте сгенерированные схемы** — убедитесь, что они соответствуют вашим ожиданиям
4. **Обновляйте тесты при необходимости** — генератор может создавать тесты, но иногда их нужно обновить вручную

## Устранение неполадок

### Схема не генерируется

- Убедитесь, что интерфейс не находится в списке игнорируемых
- Проверьте, что интерфейс находится в директории `libs/shared/src/lib/types`
- Убедитесь, что интерфейс экспортируется (имеет ключевое слово `export`)

### Ошибки при генерации схем

- Проверьте синтаксис TypeScript-интерфейса
- Убедитесь, что все типы, используемые в интерфейсе, доступны
- Проверьте JSDoc-комментарии на наличие ошибок

### Тесты не проходят после генерации схем

- Обновите тесты вручную, чтобы они соответствовали новым схемам
- Запустите мониторинг схем, чтобы увидеть несоответствия между схемами и тестами

## Заключение

Генератор JSON-схем — это мощный инструмент, который помогает поддерживать синхронизацию между TypeScript-интерфейсами и JSON-схемами. Используйте его для автоматизации создания и обновления схем, чтобы сэкономить время и избежать ошибок.
Запустить генератор вручную: pnpm schema:generate
