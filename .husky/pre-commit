#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# –í–ê–ñ–ù–û: –°–ª–µ–¥—É—é—â–∏–µ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å Husky v10.0.0
# –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–æ v10.0.0 —É–¥–∞–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ #!/usr/bin/env sh –∏ . "$(dirname -- "$0")/_/husky.sh"

# –ó–∞–ø—É—Å–∫–∞–µ–º lint-staged –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
npx lint-staged

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–µ–Ω—ã –ª–∏ TypeScript-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
TS_INTERFACE_FILES=$(git diff --cached --name-only | grep -E 'libs/shared/src/lib/types/.*\.ts$' | grep -v '__tests__')

# –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã TypeScript-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ö–µ–º
if [ -n "$TS_INTERFACE_FILES" ]; then
  echo "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ TypeScript-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö. –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ö–µ–º..."
  # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ö–µ–º
  npm run schema:generate
  
  # –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ö–µ–º –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∫–æ–º–º–∏—Ç
  if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JSON-—Å—Ö–µ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º."
    exit 1
  fi
  
  # –î–æ–±–∞–≤–ª—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –≤ –∏–Ω–¥–µ–∫—Å
  git add docs/json-schema/*.json
  
  echo "‚úÖ JSON-—Å—Ö–µ–º—ã —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–æ–º–º–∏—Ç."
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–µ–Ω—ã –ª–∏ —Ñ–∞–π–ª—ã —Å—Ö–µ–º –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤
SCHEMA_FILES=$(git diff --cached --name-only | grep -E 'docs/json-schema/.*\.json$|libs/shared/src/lib/types/__tests__/.*-schema\.spec\.ts$')

if [ -n "$SCHEMA_FILES" ]; then
  echo "üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ JSON-—Å—Ö–µ–º–∞—Ö –∏–ª–∏ —Ç–µ—Å—Ç–∞—Ö. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è..."
  # –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ö–µ–º
  npm run schema:monitor
  
  # –ï—Å–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ö–µ–º –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∫–æ–º–º–∏—Ç
  if [ $? -ne 0 ]; then
    echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É —Å—Ö–µ–º–∞–º–∏ –∏ —Ç–µ—Å—Ç–∞–º–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º."
    exit 1
  fi
  
  echo "‚úÖ –í—Å–µ —Å—Ö–µ–º—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–µ—Å—Ç–∞–º."
fi
